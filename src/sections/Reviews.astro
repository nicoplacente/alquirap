---
import SectionContainer from "../components/SectionContainer.astro";
import Review from "../components/Review.astro";
import Title from "../components/Title.astro";
import { REVIEWS } from "../libs/reviews-constants.js";
---

<SectionContainer id="reviews">
  <Title>Reseñas</Title>

  <div class="relative overflow-hidden">
    <div id="slider-track" class="flex gap-6" style="will-change: transform;">
      {REVIEWS.map((review) => <Review {...review} />)}
      {REVIEWS.map((review) => <Review {...review} />)}
    </div>
  </div>
</SectionContainer>

<script is:inline>
  const track = document.getElementById("slider-track");
  const slides = Array.from(track.children);
  const total = slides.length / 2;
  let slideWidth = slides[0].offsetWidth + 24;
  let contentWidth = slideWidth * total;

  let pos = 0;
  let dragging = false;
  let moved = false;
  let startX = 0;
  let lastX = 0;
  let speed = 0;
  let requestId;

  function animate() {
    // Mueve solo si no se está arrastrando
    if (!dragging) pos -= 1;

    if (pos <= -contentWidth) pos += contentWidth;
    if (pos > 0) pos -= contentWidth;

    track.style.transform = `translateX(${pos}px)`;
    requestId = requestAnimationFrame(animate);
  }

  requestId = requestAnimationFrame(animate);

  function onStart(e) {
    e.preventDefault();
    dragging = true;
    moved = false;
    cancelAnimationFrame(requestId);

    startX = e.pageX ?? e.clientX;
    lastX = startX;

    track.setPointerCapture(e.pointerId);
  }

  function onMove(e) {
    if (!dragging) return;

    const x = e.pageX ?? e.clientX;
    const delta = x - lastX;

    // Solo mueve si hay desplazamiento real
    if (Math.abs(delta) > 0.5) {
      moved = true;
      pos += delta;
      track.style.transform = `translateX(${pos}px)`;
    }

    speed = delta;
    lastX = x;
  }

  function onEnd(e) {
    if (!dragging) return;
    dragging = false;
    track.releasePointerCapture(e.pointerId);
    speed = 0;

    // Si solo mantuvo presionado sin mover, no pasa nada raro
    requestId = requestAnimationFrame(animate);
  }

  track.addEventListener("pointerdown", onStart);
  track.addEventListener("pointermove", onMove);
  track.addEventListener("pointerup", onEnd);
  track.addEventListener("pointercancel", onEnd);
  track.addEventListener("lostpointercapture", onEnd);

  window.addEventListener("resize", () => {
    slideWidth = slides[0].offsetWidth + 24;
    contentWidth = slideWidth * total;
  });
</script>
